{% extends 'projects/base.html' %}
{% load indian_format %}

{% block content %}

<style>
/* ---------- Layout ---------- */
.expense-wrapper {
  max-width: 1100px;
  margin: 0 auto;
  padding: 24px;
}

.expense-card {
  background: #ffffff;
  border-radius: 18px;
  box-shadow: 0 20px 40px rgba(15,23,42,.08);
  padding: 28px;
  margin-bottom: 28px;
}

/* ---------- Header ---------- */
.expense-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.expense-header h2 {
  font-weight: 700;
  color: #0f172a;
  margin: 0;
}

/* ---------- Form ---------- */
.expense-form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
}

.expense-form label {
  font-size: 13px;
  font-weight: 600;
  color: #475569;
}

.expense-form input,
.expense-form select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid #cbd5e1;
  background: #f8fafc;
  font-size: 14px;
}

.expense-form input:focus,
.expense-form select:focus {
  outline: none;
  border-color: #2563eb;
  background: #ffffff;
}

/* ---------- Button ---------- */
.btn-submit {
  grid-column: 1 / -1;
  margin-top: 10px;
  background: #2563eb;
  color: #fff;
  border: none;
  padding: 12px;
  border-radius: 12px;
  font-weight: 600;
}

.btn-submit:hover {
  background: #1d4ed8;
}

/* ---------- Table ---------- */
.expense-table-card {
  background: #ffffff;
  border-radius: 18px;
  box-shadow: 0 20px 40px rgba(15,23,42,.08);
  padding: 20px;
}

.table thead th {
  background: #f1f5f9;
  font-size: 13px;
}

.table td {
  font-size: 14px;
}

.total-row {
  background: #ecfeff;
  font-weight: 700;
}

/* ---------- Responsive ---------- */
@media (max-width: 576px) {
  .table th,
  .table td {
    font-size: 12px;
    white-space: nowrap;
  }
}
</style>

<div class="expense-wrapper">

  <!-- ================= Add Expense ================= -->
  <div class="expense-card">

    <div class="expense-header">
      <h2>Add Budget / Expense</h2>
    </div>

    {% if success %}
      <div class="alert alert-success">
        Expense added successfully!
      </div>
    {% endif %}

    <form method="POST" action="{% url 'add_expense' %}" class="expense-form">
      {% csrf_token %}

      <div>
        <label>Project</label>
        <select name="project" required onchange="this.form.submit()">
          <option value="" disabled {% if not selected_project_id %}selected{% endif %}>Select Project</option>
          {% for project in projects %}
            <option value="{{ project.id }}" {% if project.id == selected_project_id %}selected{% endif %}>
              {{ project.name }} ({{ project.client_name }})
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label>Description</label>
        <input type="text" name="description" required>
      </div>

      <div>
        <label>Area</label>
        <input type="number" step="0.01" name="area" required>
      </div>

      <div>
        <label>Unit</label>
        <input type="text" name="unit" required>
      </div>

      <div>
        <label>Rate</label>
        <input type="number" step="0.01" name="rate" required>
      </div>

      <div>
        <label>Date</label>
        <input type="date" name="date" required>
      </div>

      <button type="submit" name="add_expense" class="btn-submit">
        <i class="bi bi-plus-circle"></i> Add Expense
      </button>
    </form>
  </div>

  <!-- ================= Expense List ================= -->
  <div class="expense-table-card">

    <h4 class="mb-3">
      Expenses for
      {% for project in projects %}
        {% if project.id == selected_project_id %}
          {{ project.client_name }}
        {% endif %}
      {% endfor %}
    </h4>

    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="text-center">
          <tr class="total-row">
            <th colspan="7">Total Expenses: ₹{{ total_expense|default:"0.00" }}</th>
          </tr>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Area</th>
            <th>Unit</th>
            <th>Rate</th>
            <th>Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for expense in expenses %}
          <tr>
            <td>{{ expense.date }}</td>
            <td>{{ expense.description }}</td>
            <td>{{ expense.area }}</td>
            <td>{{ expense.unit }}</td>
            <td>₹{{ expense.rate }}</td>
            <td>₹{{ expense.amount }}</td>
            <td class="text-center">
              <a href="{% url 'edit_expense' expense.id %}" class="btn btn-sm btn-primary">Edit</a>
              <a href="{% url 'delete_expense' expense.id %}"
                 class="btn btn-sm btn-danger"
                 onclick="return confirm('Delete this expense?');">
                 Delete
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted">
              No expenses added yet.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

</div>

{% endblock %}
