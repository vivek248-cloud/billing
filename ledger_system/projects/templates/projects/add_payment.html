{% extends 'projects/base.html' %}
{% load static %}
{% load indian_format %}

{% block content %}

<div class="payment-wrapper">

  <div class="payment-card">

    <!-- Header -->
    <div class="payment-header">
      <h3>Add Payment</h3>
      <p>Record payments received from clients</p>
    </div>

    <!-- Messages -->
    {% if messages %}
      <div class="message-box">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Add Payment Form -->
    <form method="post" action="{% url 'add_payment' %}" class="payment-form">
      {% csrf_token %}

      <div class="form-group">
        <label>Select Client</label>
        <select name="project" required onchange="this.form.submit()">
          <option value="" disabled {% if not selected_project_id %}selected{% endif %}>
            Select Client
          </option>
          {% for project in projects %}
            <option value="{{ project.id }}" {% if project.id == selected_project_id %}selected{% endif %}>
              {{ project.client_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      {% if selected_project_id %}
      <div class="project-summary">
        <div>
          <span>Total Paid</span>
          <strong>{{ total_paid|indian_currency }}</strong>
        </div>
        <div>
          <span>Yet to Receive</span>
          <strong class="{% if selected_project.remaining < 0 %}text-danger{% endif %}">
            {{ selected_project.remaining|indian_currency }}
          </strong>
        </div>
      </div>
      {% endif %}

      <div class="form-grid">
        <div class="form-group">
          <label>Amount (â‚¹)</label>
          <input type="number" name="amount" step="0.01" required placeholder="Enter amount">
        </div>

        <div class="form-group">
          <label>Payment Mode</label>
          <select name="payment_mode" required>
            <option value="" disabled selected>Select mode</option>
            <option value="Cash">Cash</option>
            <option value="Bank Transfer">Bank Transfer</option>
            <option value="Cheque">Cheque</option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-save">
          <i class="bi bi-plus-circle"></i> Add Payment
        </button>
      </div>

    </form>

    <!-- Payment List -->
    {% if payments %}
    <div class="payment-table-wrapper table-responsive">
      <h4>Payments for Selected Project</h4>

      <table class="payment-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Amount</th>
            <th>Mode</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ payment.amount|indian_currency }}</td>
            <td>{{ payment.payment_mode }}</td>
            <td>{{ payment.date|date:"d M Y" }}</td>
            <td class="actions">
              <a href="{% url 'edit_payment' payment.id %}" class="btn-edit">
                <i class="bi bi-pencil"></i>
              </a>

              <form method="post" action="{% url 'delete_payment' payment.id %}" class="inline-form">
                {% csrf_token %}
                <button type="submit" class="btn-delete"
                  onclick="return confirm('Delete this payment?');">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

  </div>
</div>

{% endblock %}
